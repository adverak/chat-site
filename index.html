<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Chat with Voice Call</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<h2>Chat (Signup/Login Required)</h2>

<div id="authDiv">
  <h3>Signup</h3>
  <input id="signupUser" placeholder="Username" style="width:95%; padding:5px;"><br>
  <input id="signupPass" type="password" placeholder="Password" style="width:95%; padding:5px;"><br>
  <button onclick="signup()">Signup</button>

  <h3>Login</h3>
  <input id="loginUser" placeholder="Username" style="width:95%; padding:5px;"><br>
  <input id="loginPass" type="password" placeholder="Password" style="width:95%; padding:5px;"><br>
  <button onclick="login()">Login</button>
</div>

<div id="chatDiv" style="display:none;">
  <p>Logged in as: <span id="userNameDisplay"></span> <button onclick="logout()">Logout</button></p>
  <p id="adminStatus" style="font-weight:bold;"></p>

  <p>
    Room:<br>
    <button onclick="setRoom('general')" style="width:30%; margin:2px;">general</button>
    <button onclick="setRoom('gaming')" style="width:30%; margin:2px;">gaming</button>
    <button onclick="setRoom('random')" style="width:30%; margin:2px;">random</button>
    <button id="clearBtn" onclick="clearRoom()" style="width:95%; margin:5px; background-color:red; color:white; display:none;">Clear Room (Admin)</button>
  </p>

  <p>Current room: <span id="roomName">general</span></p>

  <div id="messages" style="border:1px solid #000; height:300px; overflow-y:auto; padding:5px; margin-bottom:5px;"></div>

  <form id="chat-form">
    <input id="message" placeholder="Type message" required style="width:70%; padding:5px;">
    <button type="submit" style="width:25%; padding:5px;">Send</button>
  </form>

  <p>
    <button id="startCall">Start Voice Call</button>
    <audio id="remoteAudio" autoplay></audio>
  </p>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const adminName = "Kuma";
let currentUser = null;

const firebaseConfig = {
  apiKey: "AIzaSyDPrESTFgUAoFjMCCnTtqvGFknmEWb2_Y4",
  authDomain: "github-chat-c891d.firebaseapp.com",
  databaseURL: "https://github-chat-c891d-default-rtdb.firebaseio.com",
  projectId: "github-chat-c891d",
  appId: "1:872611172640:web:c404e43cf0dc7a09644745"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentRoom = "general";
let writeRef = db.ref("rooms/" + currentRoom);
let readRef = writeRef.limitToLast(50);

// ----------------- HASH FUNCTION -----------------
async function hashPassword(password){
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

// ----------------- SIGNUP -----------------
async function signup(){
  const username = document.getElementById("signupUser").value.trim();
  const password = document.getElementById("signupPass").value.trim();
  if(!username || !password){ alert("Enter username and password"); return; }

  const userRef = db.ref("users/" + username);
  const snapshot = await userRef.get();
  if(snapshot.exists()){
    alert("Username already exists");
    return;
  }

  const hashed = await hashPassword(password);
  await userRef.set({ password: hashed });
  alert("Signup successful! Please login.");
  document.getElementById("signupUser").value="";
  document.getElementById("signupPass").value="";
}

// ----------------- LOGIN -----------------
async function login(){
  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPass").value.trim();
  if(!username || !password){ alert("Enter username and password"); return; }

  const userRef = db.ref("users/" + username);
  const snapshot = await userRef.get();
  if(!snapshot.exists()){ alert("Username does not exist"); return; }

  const hashed = await hashPassword(password);
  if(hashed !== snapshot.val().password){ alert("Incorrect password"); return; }

  currentUser = username;
  localStorage.setItem("chatUser", currentUser); // persistent login
  document.getElementById("userNameDisplay").innerText = currentUser;
  document.getElementById("authDiv").style.display = "none";
  document.getElementById("chatDiv").style.display = "block";

  if(currentUser === adminName){ document.getElementById("clearBtn").style.display = "block"; }

  loadMessages();
}

// ----------------- LOGOUT -----------------
function logout(){
  localStorage.removeItem("chatUser");
  currentUser = null;
  document.getElementById("authDiv").style.display = "block";
  document.getElementById("chatDiv").style.display = "none";
}

// ----------------- CHECK LOGIN ON PAGE LOAD -----------------
window.onload = function() {
  const storedUser = localStorage.getItem("chatUser");
  if(storedUser) {
    currentUser = storedUser;
    document.getElementById("userNameDisplay").innerText = currentUser;
    document.getElementById("authDiv").style.display = "none";
    document.getElementById("chatDiv").style.display = "block";
    if(currentUser === adminName) document.getElementById("clearBtn").style.display = "block";
    loadMessages();
  }
};

// ----------------- CHAT FUNCTIONS -----------------
function setRoom(room){
  currentRoom = room;
  document.getElementById("roomName").innerText = room;
  readRef.off();
  writeRef = db.ref("rooms/" + room);
  readRef = writeRef.limitToLast(50);
  document.getElementById("messages").innerHTML = "";
  loadMessages();
}

function loadMessages(){
  const adminStatus = document.getElementById("adminStatus");
  let adminPresent = false;

  readRef.on("child_added", snap => {
    const msg = snap.val();
    const div = document.createElement("div");
    div.style.borderBottom = "1px solid #ccc";
    div.style.padding = "2px 0";

    let displayText = msg.text;
    if(msg.user === adminName){
      div.style.fontWeight="bold"; // no color
      displayText = "Admin: " + msg.user + ": " + msg.text;
      adminPresent = true;
      adminStatus.innerText = "Admin account: " + adminName;
    }

    if(msg.user !== adminName){
      displayText = msg.user + ": " + msg.text;
    }

    if(!adminPresent){
      adminStatus.innerText = "";
    }

    div.innerText = displayText;

    if(currentUser === adminName){
      const delBtn = document.createElement("button");
      delBtn.innerText="X";
      delBtn.style.marginLeft="5px";
      delBtn.onclick = () => writeRef.child(snap.key).remove();
      div.appendChild(delBtn);
    }

    document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
  });
}

document.getElementById("chat-form").addEventListener("submit", e=>{
  e.preventDefault();
  if(!currentUser){ alert("Please login first"); return; }
  const text = document.getElementById("message").value;
  if(!text) return;

  writeRef.push({ user: currentUser, text: text, time: Date.now() });
  document.getElementById("message").value="";
});

function clearRoom(){
  if(currentUser !== adminName){ alert("Only admin can clear the room!"); return; }
  if(confirm("Are you sure you want to clear all messages in this room?")){
    writeRef.remove();
    document.getElementById("messages").innerHTML="";
  }
}

// ----------------- VOICE CALL -----------------
let localStream;
let pc;
const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
let callRef;

document.getElementById("startCall").onclick = async function() {
  if(!currentUser){ alert("Please login first"); return; }

  callRef = db.ref("calls/" + currentRoom);
  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

  pc = new RTCPeerConnection(servers);
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = (event) => {
    document.getElementById("remoteAudio").srcObject = event.streams[0];
  };

  pc.onicecandidate = (event) => {
    if(event.candidate){
      callRef.push({ type: "candidate", candidate: event.candidate.toJSON(), sender: currentUser });
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  callRef.push({ type: "offer", sdp: offer.sdp, sender: currentUser });

  callRef.on("child_added", async (snap) => {
    const data = snap.val();
    if(data.sender === currentUser) return;

    if(data.type === "answer"){
      await pc.setRemoteDescription({ type: "answer", sdp: data.sdp });
    } else if(data.type === "candidate"){
      try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); } 
      catch(e){ console.error(e); }
    } else if(data.type === "offer"){
      if(!pc){
        pc = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        pc.ontrack = (event) => document.getElementById("remoteAudio").srcObject = event.streams[0];
        pc.onicecandidate = (event) => {
          if(event.candidate) callRef.push({ type: "candidate", candidate: event.candidate.toJSON(), sender: currentUser });
        };
      }
      await pc.setRemoteDescription({ type: "offer", sdp: data.sdp });
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      callRef.push({ type: "answer", sdp: answer.sdp, sender: currentUser });
    }
  });
};
</script>
</body>
</html>
