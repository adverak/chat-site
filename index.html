<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Chat with Multi-User Voice Call</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  background-color: white;
  color: black;
  font-family: Arial, sans-serif;
}

#messages {
  background-color: #f0f0f0;
}

#chatDiv input, #chatDiv button {
  background-color: white;
  color: black;
  border: 1px solid #ccc;
}

.dark-mode {
  background-color: #121212 !important;
  color: #e0e0e0 !important;
}

.dark-mode #messages {
  background-color: #1e1e1e !important;
}

.dark-mode #chatDiv input, .dark-mode #chatDiv button {
  background-color: #1e1e1e !important;
  color: #e0e0e0 !important;
  border: 1px solid #444 !important;
}
</style>
</head>
<body>

<h2>Chat (Signup/Login Required)</h2>
<p><button id="toggleDarkMode">Toggle Dark Mode</button></p>

<div id="authDiv">
  <h3>Signup</h3>
  <input id="signupUser" placeholder="Username" style="width:95%; padding:5px;"><br>
  <input id="signupPass" type="password" placeholder="Password" style="width:95%; padding:5px;"><br>
  <button onclick="signup()">Signup</button>

  <h3>Login</h3>
  <input id="loginUser" placeholder="Username" style="width:95%; padding:5px;"><br>
  <input id="loginPass" type="password" placeholder="Password" style="width:95%; padding:5px;"><br>
  <button onclick="login()">Login</button>
</div>

<div id="chatDiv" style="display:none;">
  <p>Logged in as: <span id="userNameDisplay"></span> <button onclick="logout()">Logout</button></p>
  <p id="adminStatus" style="font-weight:bold;"></p>

  <p>
    Room:<br>
    <button onclick="setRoom('general')" style="width:30%; margin:2px;">general</button>
    <button onclick="setRoom('gaming')" style="width:30%; margin:2px;">gaming</button>
    <button onclick="setRoom('random')" style="width:30%; margin:2px;">random</button>
    <button id="clearBtn" onclick="clearRoom()" style="width:95%; margin:5px; background-color:red; color:white; display:none;">Clear Room (Admin)</button>
  </p>

  <p>Current room: <span id="roomName">general</span></p>

  <div id="messages" style="border:1px solid #000; height:300px; overflow-y:auto; padding:5px; margin-bottom:5px;"></div>

  <form id="chat-form">
    <input id="message" placeholder="Type message" required style="width:70%; padding:5px;">
    <button type="submit" style="width:25%; padding:5px;">Send</button>
  </form>

  <p>
    <button id="startCall">Join Voice Call</button>
    <button id="leaveCall" style="display:none;">Leave Voice Call</button>
  </p>

  <p>Users in voice call:</p>
  <ul id="voiceUsersList"></ul>

  <div id="remoteAudios"></div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const adminName = "Kuma";
let currentUser = null;

const firebaseConfig = {
  apiKey: "AIzaSyDPrESTFgUAoFjMCCnTtqvGFknmEWb2_Y4",
  authDomain: "github-chat-c891d.firebaseapp.com",
  databaseURL: "https://github-chat-c891d-default-rtdb.firebaseio.com",
  projectId: "github-chat-c891d",
  appId: "1:872611172640:web:c404e43cf0dc7a09644745"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentRoom = "general";
let writeRef = db.ref("rooms/" + currentRoom);
let readRef = writeRef.limitToLast(50);

// ----------------- HASH FUNCTION -----------------
async function hashPassword(password){
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

// ----------------- SIGNUP -----------------
async function signup(){
  const username = document.getElementById("signupUser").value.trim();
  const password = document.getElementById("signupPass").value.trim();
  if(!username || !password){ alert("Enter username and password"); return; }

  const userRef = db.ref("users/" + username);
  const snapshot = await userRef.get();
  if(snapshot.exists()){
    alert("Username already exists");
    return;
  }

  const hashed = await hashPassword(password);
  await userRef.set({ password: hashed });
  alert("Signup successful! Please login.");
  document.getElementById("signupUser").value="";
  document.getElementById("signupPass").value="";
}

// ----------------- LOGIN -----------------
async function login(){
  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPass").value.trim();
  if(!username || !password){ alert("Enter username and password"); return; }

  const userRef = db.ref("users/" + username);
  const snapshot = await userRef.get();
  if(!snapshot.exists()){ alert("Username does not exist"); return; }

  const hashed = await hashPassword(password);
  if(hashed !== snapshot.val().password){ alert("Incorrect password"); return; }

  currentUser = username;
  localStorage.setItem("chatUser", currentUser);
  document.getElementById("userNameDisplay").innerText = currentUser;
  document.getElementById("authDiv").style.display = "none";
  document.getElementById("chatDiv").style.display = "block";

  if(currentUser === adminName){ document.getElementById("clearBtn").style.display = "block"; }

  loadMessages();
  setupVoiceUsersListener();
}

// ----------------- LOGOUT -----------------
function logout(){
  leaveVoiceCall(); 
  localStorage.removeItem("chatUser");
  currentUser = null;
  document.getElementById("authDiv").style.display = "block";
  document.getElementById("chatDiv").style.display = "none";
}

// ----------------- CHECK LOGIN ON PAGE LOAD -----------------
window.onload = function() {
  const storedUser = localStorage.getItem("chatUser");
  if(storedUser) {
    currentUser = storedUser;
    document.getElementById("userNameDisplay").innerText = currentUser;
    document.getElementById("authDiv").style.display = "none";
    document.getElementById("chatDiv").style.display = "block";
    if(currentUser === adminName) document.getElementById("clearBtn").style.display = "block";
    loadMessages();
    setupVoiceUsersListener();
  }
};

// ----------------- CHAT FUNCTIONS -----------------
function setRoom(room){
  leaveVoiceCall(); 
  currentRoom = room;
  document.getElementById("roomName").innerText = room;
  readRef.off();
  writeRef = db.ref("rooms/" + room);
  readRef = writeRef.limitToLast(50);
  document.getElementById("messages").innerHTML = "";
  loadMessages();
  setupVoiceUsersListener();
}

function loadMessages(){
  const adminStatus = document.getElementById("adminStatus");
  let adminPresent = false;

  readRef.on("child_added", snap => {
    const msg = snap.val();
    const div = document.createElement("div");
    div.style.borderBottom = "1px solid #ccc";
    div.style.padding = "2px 0";

    let displayText = msg.text;
    if(msg.user === adminName){
      div.style.fontWeight="bold"; 
      displayText = "Admin: " + msg.user + ": " + msg.text;
      adminPresent = true;
      adminStatus.innerText = "Admin account: " + adminName;
    }

    if(msg.user !== adminName){
      displayText = msg.user + ": " + msg.text;
    }

    if(!adminPresent){
      adminStatus.innerText = "";
    }

    div.innerText = displayText;

    if(currentUser === adminName){
      const delBtn = document.createElement("button");
      delBtn.innerText="X";
      delBtn.style.marginLeft="5px";
      delBtn.onclick = () => writeRef.child(snap.key).remove();
      div.appendChild(delBtn);
    }

    document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
  });
}

document.getElementById("chat-form").addEventListener("submit", e=>{
  e.preventDefault();
  if(!currentUser){ alert("Please login first"); return; }
  const text = document.getElementById("message").value;
  if(!text) return;

  writeRef.push({ user: currentUser, text: text, time: Date.now() });
  document.getElementById("message").value="";
});

function clearRoom(){
  if(currentUser !== adminName){ alert("Only admin can clear the room!"); return; }
  if(confirm("Are you sure you want to clear all messages in this room?")){
    writeRef.remove();
    document.getElementById("messages").innerHTML="";
  }
}

// ----------------- MULTI-USER VOICE CALL -----------------
let localStream;
let peers = {}; 
let inVoiceCall = false;

const voiceUsersRef = () => db.ref("voiceUsers/" + currentRoom);
const callsRef = () => db.ref("calls/" + currentRoom);

// Beep sound function
function playJoinSound(){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = ctx.createOscillator();
  const gainNode = ctx.createGain();

  oscillator.type = 'sine';
  oscillator.frequency.setValueAtTime(440, ctx.currentTime);
  gainNode.gain.setValueAtTime(0.2, ctx.currentTime);

  oscillator.connect(gainNode);
  gainNode.connect(ctx.destination);

  oscillator.start();
  oscillator.stop(ctx.currentTime + 0.2);
}

function updateVoiceUsersList(users){
  const list = document.getElementById("voiceUsersList");
  list.innerHTML = "";
  users.forEach(u=>{
    const li = document.createElement("li");
    li.innerText = u;
    list.appendChild(li);
  });
}

function setupVoiceUsersListener(){
  let previousUsers = [];
  
  voiceUsersRef().on("value", snap => {
    const usersObj = snap.val() || {};
    const users = Object.keys(usersObj);

    users.forEach(u => {
      if(!previousUsers.includes(u)){
        if(u !== currentUser){
          playJoinSound();
        }
      }
    });

    previousUsers = users;
    updateVoiceUsersList(users);
  });
}

async function createPeerConnection(otherUser, isInitiator){
  if(peers[otherUser]) return;
  const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
  peers[otherUser] = pc;

  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  const remoteAudio = document.createElement("audio");
  remoteAudio.autoplay = true;
  remoteAudio.id = "audio_" + otherUser;
  document.getElementById("remoteAudios").appendChild(remoteAudio);

  pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; };

  pc.onicecandidate = e => {
    if(e.candidate) callsRef().child(currentUser + "_" + otherUser).set({ type: "candidate", candidate: e.candidate.toJSON() });
  };

  if(isInitiator){
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    callsRef().child(currentUser + "_" + otherUser).set({ type: "offer", sdp: offer.sdp });
  }
}

function setupCallListener(){
  callsRef().on("child_added", async snap => {
    const data = snap.val();
    const keyParts = snap.key.split("_");
    const sender = keyParts[0], receiver = keyParts[1];

    if(receiver !== currentUser) return;
    if(!peers[sender]) await createPeerConnection(sender, false);

    const pc = peers[sender];

    if(data.type === "offer"){
      await pc.setRemoteDescription({ type: "offer", sdp: data.sdp });
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      callsRef().child(currentUser + "_" + sender).set({ type: "answer", sdp: answer.sdp });
    } else if(data.type === "answer"){
      await pc.setRemoteDescription({ type: "answer", sdp: data.sdp });
    } else if(data.type === "candidate"){
      try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); } 
      catch(e){ console.error(e); }
    }
  });
}

async function joinVoiceCall(){
  if(inVoiceCall) return;
  if(!currentUser) return alert("Login first");

  inVoiceCall = true;
  document.getElementById("startCall").style.display="none";
  document.getElementById("leaveCall").style.display="inline";

  await voiceUsersRef().child(currentUser).set(true);

  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

  voiceUsersRef().once("value", snap => {
    const usersObj = snap.val() || {};
    Object.keys(usersObj).forEach(u => {
      if(u !== currentUser) createPeerConnection(u, true);
    });
  });

  setupCallListener();
}

async function leaveVoiceCall(){
  if(!inVoiceCall) return;
  inVoiceCall = false;
  document.getElementById("startCall").style.display="inline";
  document.getElementById("leaveCall").style.display="none";

  await voiceUsersRef().child(currentUser).remove();

  Object.values(peers).forEach(pc => pc.close());
  peers = {};

  document.getElementById("remoteAudios").innerHTML="";
}

document.getElementById("startCall").onclick = joinVoiceCall;
document.getElementById("leaveCall").onclick = leaveVoiceCall;
window.addEventListener("beforeunload", async () => {
  if(inVoiceCall && currentUser){
    await voiceUsersRef().child(currentUser).remove();
  }
});

// ----------------- DARK MODE -----------------
document.getElementById("toggleDarkMode").onclick = () => {
  document.body.classList.toggle("dark-mode");
};
</script>
</body>
</html>
