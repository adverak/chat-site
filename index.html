<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 10px; }
  input, button { font-size: 1em; margin: 2px 0; }
  #messages { border: 1px solid #000; height: 300px; overflow-y: auto; padding: 5px; margin-bottom: 5px; }
  .message { padding: 5px 8px; border-radius: 5px; margin-bottom: 3px; }
  .user-message { background-color: #f0f0f0; }
  .admin-message { font-weight: bold; } /* bold, no color */
  .message button { margin-left: 5px; font-size: 0.8em; }
  #chat-form { display: flex; gap: 5px; }
  #chat-form input { flex: 1; }
  #chat-form button { flex: 0 0 80px; }
  #roomButtons button { flex: 1; margin: 2px; }
</style>
</head>
<body>

<h2>Chat (Signup/Login Required)</h2>

<div id="authDiv">
  <h3>Signup</h3>
  <input id="signupUser" placeholder="Username" style="width:100%;"><br>
  <input id="signupPass" type="password" placeholder="Password" style="width:100%;"><br>
  <button onclick="signup()">Signup</button>

  <h3>Login</h3>
  <input id="loginUser" placeholder="Username" style="width:100%;"><br>
  <input id="loginPass" type="password" placeholder="Password" style="width:100%;"><br>
  <button onclick="login()">Login</button>
</div>

<div id="chatDiv" style="display:none;">
  <p>Logged in as: <span id="userNameDisplay"></span> <button onclick="logout()">Logout</button></p>
  <p id="adminStatus"></p>

  <div id="roomButtons" style="display:flex; margin-bottom:5px;">
    <button onclick="setRoom('general')">General</button>
    <button onclick="setRoom('gaming')">Gaming</button>
    <button onclick="setRoom('random')">Random</button>
  </div>
  <button id="clearBtn" onclick="clearRoom()" style="width:100%; background-color:red; color:white; display:none;">Clear Room (Admin)</button>

  <p>Current room: <span id="roomName">general</span></p>

  <div id="messages"></div>

  <form id="chat-form">
    <input id="message" placeholder="Type message" required>
    <button type="submit">Send</button>
  </form>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ---------------- JS from previous full version ----------------
const adminName = "Kuma";
let currentUser = null;
const firebaseConfig = {
  apiKey: "AIzaSyDPrESTFgUAoFjMCCnTtqvGFknmEWb2_Y4",
  authDomain: "github-chat-c891d.firebaseapp.com",
  databaseURL: "https://github-chat-c891d-default-rtdb.firebaseio.com",
  projectId: "github-chat-c891d",
  appId: "1:872611172640:web:c404e43cf0dc7a09644745"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentRoom = "general";
let writeRef = db.ref("rooms/" + currentRoom);
let readRef = writeRef.limitToLast(50);

async function hashPassword(password){
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

async function signup(){
  const username = document.getElementById("signupUser").value.trim();
  const password = document.getElementById("signupPass").value.trim();
  if(!username || !password){ alert("Enter username and password"); return; }
  const userRef = db.ref("users/" + username);
  const snapshot = await userRef.get();
  if(snapshot.exists()){ alert("Username exists"); return; }
  const hashed = await hashPassword(password);
  await userRef.set({ password: hashed });
  alert("Signup successful! Please login.");
}

async function login(){
  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPass").value.trim();
  if(!username || !password){ alert("Enter username and password"); return; }
  const userRef = db.ref("users/" + username);
  const snapshot = await userRef.get();
  if(!snapshot.exists()){ alert("Username does not exist"); return; }
  const hashed = await hashPassword(password);
  if(hashed !== snapshot.val().password){ alert("Incorrect password"); return; }
  currentUser = username;
  localStorage.setItem("chatUser", currentUser);
  document.getElementById("userNameDisplay").innerText = currentUser;
  document.getElementById("authDiv").style.display = "none";
  document.getElementById("chatDiv").style.display = "block";
  if(currentUser === adminName) document.getElementById("clearBtn").style.display = "block";
  loadMessages();
}

function logout(){
  localStorage.removeItem("chatUser");
  currentUser = null;
  document.getElementById("authDiv").style.display = "block";
  document.getElementById("chatDiv").style.display = "none";
}

window.onload = function() {
  const storedUser = localStorage.getItem("chatUser");
  if(storedUser) {
    currentUser = storedUser;
    document.getElementById("userNameDisplay").innerText = currentUser;
    document.getElementById("authDiv").style.display = "none";
    document.getElementById("chatDiv").style.display = "block";
    if(currentUser === adminName) document.getElementById("clearBtn").style.display = "block";
    loadMessages();
  }
};

function setRoom(room){
  currentRoom = room;
  document.getElementById("roomName").innerText = room;
  readRef.off();
  writeRef = db.ref("rooms/" + room);
  readRef = writeRef.limitToLast(50);
  document.getElementById("messages").innerHTML = "";
  loadMessages();
}

function loadMessages(){
  const adminStatus = document.getElementById("adminStatus");
  let adminPresent = false;

  readRef.on("child_added", snap => {
    const msg = snap.val();
    const div = document.createElement("div");
    div.className = "message";

    let displayText = msg.text;
    if(msg.user === adminName){
      div.classList.add("admin-message");
      displayText = "Admin: " + msg.user + ": " + msg.text;
      adminPresent = true;
      adminStatus.innerText = "Admin account: " + adminName;
    } else {
      div.classList.add("user-message");
      displayText = msg.user + ": " + msg.text;
    }

    if(!adminPresent) adminStatus.innerText = "";

    div.innerText = displayText;

    if(currentUser === adminName){
      const delBtn = document.createElement("button");
      delBtn.innerText="X";
      delBtn.onclick = () => writeRef.child(snap.key).remove();
      div.appendChild(delBtn);
    }

    document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
  });
}

document.getElementById("chat-form").addEventListener("submit", e=>{
  e.preventDefault();
  if(!currentUser){ alert("Please login first"); return; }
  const text = document.getElementById("message").value;
  if(!text) return;
  writeRef.push({ user: currentUser, text: text, time: Date.now() });
  document.getElementById("message").value="";
});

function clearRoom(){
  if(currentUser !== adminName){ alert("Only admin can clear the room!"); return; }
  if(confirm("Are you sure you want to clear all messages in this room?")){
    writeRef.remove();
    document.getElementById("messages").innerHTML="";
  }
}
</script>
</body>
</html>
